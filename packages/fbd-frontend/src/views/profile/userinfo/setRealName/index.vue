<template>
  <div class="set">
    <!-- Header -->
    <d-header-row
      :left-components="'GoBack'"
      :middle-components="'Title'"
      :title="$t('views_profile_userinfo_realName')"
    />
    <a-form
      :model="state.form"
      ref="formRef"
      :label-col="{ span: 0 }"
      :wrapper-col="{ span: 24 }"
      :rules="rules"
    >
      <div class="set-area">
        <!-- 真實姓名 -->
        <div
          class="set-area-title"
          :class="`style${siteStyle}`"
        >
          {{ $t('views_profile_userinfo_realName') }}:
        </div>
        <a-form-item
          class="mb-2"
          name="realName"
        >
          <a-input
            v-model:value="state.form.realName"
            :placeholder="$t('views_profile_userinfo_setNickName_pleaseEnterRealName')"
            :class="`style${siteStyle}`"
          />
        </a-form-item>
        <!-- 修改警告 -->
        <div
          class="set-area-warning"
          :class="`style${siteStyle}`"
        >
          {{ $t('views_profile_userinfo_setRealName_warning') }}
        </div>
        <!-- 確認按鈕 -->
        <d-button
          type="primary"
          block
          class="mt-8 is-btn"
          :loading="loading"
          :disabled="!state.form.realName || loading"
          @click="submit"
        >
          {{ $t('common_confirm') }}
        </d-button>
      </div>
    </a-form>
  </div>
</template>

<script>
import {
  ref, reactive, computed,
} from 'vue';
import { useI18n } from 'vue-i18n';
import { useRouter } from 'vue-router';
import { useStore } from 'vuex';
import MemberApi from '@/assets/js/api/memberApi';

export default {
  setup() {
    // use
    const { t } = useI18n();
    const router = useRouter();
    const store = useStore();

    // inject
    // const validator = inject('$validator');

    // ref
    const formRef = ref(null);
    const loading = ref(false);

    // reactive
    const state = reactive({
      form: {
        realName: '',
      },
    });

    const realNameValidate = async (rule, value) => {
      if (!value || !value.trim()) {
        loading.value = false;
        return Promise.reject(new Error(t('error8')));
      }
      if (value.length > 50) {
        loading.value = false;
        return Promise.reject(new Error(t('error11')));
      }
      if (/[`~!@#$^&%*()=|{}':;',[\].<>/?~！@#￥……&*（）——|{}【】‘；：”“'。，、？/+/-\d]/.test(value)) {
        loading.value = false;
        return Promise.reject(new Error(t('error9')));
      }
      return Promise.resolve();
    };

    const rules = {
      realName: [{ required: true, validator: realNameValidate, trigger: ['change', 'blur'] }],
    };

    // computed
    const siteStyle = computed(() => store.getters.siteStyle);
    const serviceUrl = computed(() => store.state.info.serviceUrl);
    const account = computed(() => store.state.user.account);

    // methods
    const submit = () => {
      formRef.value.validate().then(async () => {
        loading.value = true;
        // if (state.form.realName) {
        //   let validateResult = true;

        //   validateResult = validator.value.validateName(state.form.realName);
        //   if (!validateResult.result) {
        //     window.$vue.$message.error(validateResult.errorMsg);
        //     loading.value = false;
        //     return;
        //   }
        // }
        const params = {
          name: state.form.realName,
        };
        const res = await MemberApi.updateMember(account.value, params);
        loading.value = false;
        if (res.code === 200) {
          store.commit('SET_NAME', res.data.name);
          window.$vue.$message.success(t('common_modifySuccess'));
          state.form.realName = '';
          router.back();
        } else {
          window.$vue.$message.error(res.message);
        }
      });
    };

    return {
      formRef,
      loading,
      state,
      serviceUrl,
      submit,
      rules,
      siteStyle,
    };
  },
};
</script>

<style lang="postcss" scoped>
.set {
  @apply bg-layout bg-no-repeat bg-contain h-full pt-h-h px-3 pb-4;

  &-area {
    @apply mt-4;

    .ant-input {
      color: #4d5772 !important;
      background-color: #fff !important;

      &.style2 {
        border: 1px solid var(--input-bg) !important;
        color: var(--input-font-color) !important;
        background-color: var(--input-bg) !important;
      }
    }

    &-title {
      color: #4d5772;
      font-size: 14px;

      @apply mb-2;

      &.style2 {
        color: #fff;
      }
    }

    &-warning {
      color: #f00;
      font-size: 14px;

      @apply mb-2;

      .service {
        color: #0e88f5;
      }

      &.style2 {
        color: #ff5a5a;
      }
    }
  }
}
</style>
