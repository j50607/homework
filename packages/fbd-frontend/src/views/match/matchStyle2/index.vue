<template>
  <locale
    v-slot="{locale}"
    class="market pt-h-h pb-f-h relative h-full"
  >
    <d-header-row
      v-if="!state.switchLeague"
      :left-components="'GoBack'"
      :right-components="'UserAvatar'"
      use-sidebar
      :title="state.switchLeague ?$t('views_market_switchLeague') : $t('views_market_title')"
    />
    <d-header-row
      v-else
      :right-components="'UserAvatar'"
      use-sidebar
      :title="state.switchLeague ?$t('views_market_switchLeague') : $t('views_market_title')"
    >
      <template #left>
        <div
          class="go-back"
        >
          <img
            :src="$requireSafe('header/icon-left-white.svg')"
            class="is-btn"
            @click="goBack"
          >
        </div>
      </template>
    </d-header-row>
    <div
      v-if="!state.switchLeague"
      class="tab-row px-3 flex justify-between"
    >
      <d-tabs
        v-model:activeKey="state.currentKey"
        :default-key="state.tabIndex"
        :tab-list="state.tabList"
        :class="locale"
        @change="changeTab"
        class="game-tab text-white"
      >
        <template #content>
          <league-list
            :search-league-list="state.seachLeagueList"
            :league-list-params="LeagueListParams"
            :time-filter="state.timeFilter"
          />
        </template>
      </d-tabs>
      <!-- 選擇聯盟按鈕 -->
      <div class="filter flex justify-center items-center">
        <img
          class="is-btn"
          :src="$requireSafe('icon/style2/filter.svg')"
          alt=""
          @click="handlerOpenLeagueList()"
          v-if="!state.switchLeague && state.leagueList.length > 0"
        >
      </div>
    </div>

    <!-- 選擇聯盟 -->
    <div
      class="all-league-list overflow-auto h-full flex-nowrap py-6"
      v-else
    >
      <!-- 全選跟反選 -->
      <div class="select-option flex justify-center fixed w-full left-0 h-8">
        <div
          class="select-aciton mr-3 w-2/5 flex py-1 justify-center text-xs items-center mt-auto is-btn"
          @click="selectAll"
        >
          {{ $t('views_market_switchLeague_select_all') }}
        </div>
        <div
          class="select-aciton w-2/5 flex py-1 justify-center text-xs items-center mt-auto is-btn"
          @click="invertSelect()"
        >
          {{ $t('views_market_switchLeague_select_not') }}
        </div>
      </div>
      <div
        class="league-list mx-3  my-2 p-3 rounded flex justify-start items-center cursor-pointer"
        v-for="(item,index) in state.leagueList"
        :key="index"
        @click="selectLeague(item,index)"
      >
        <div class="league-info flex items-center">
          <img
            :src="item.logoPath? `${s3Base}/${item.logoPath}`: $requireSafe('icon/default-league.svg')"
            alt=""
            class="league-img mr-2 object-contain"
          >
          <div class="league-text-content flex-1 text-sm">
            <div class="league-title mb-2">
              {{ item.leagueName }}
            </div>
            <div class="league-bet-time text-xs text-normal">
              <span>{{ $t('views_market_switchLeague_list_openCount',{num:item.openCount}) }}</span>
            </div>
          </div>
        </div>
        <img
          v-if="item.selected"
          :src="$requireSafe('icon/style2/selected.svg')"
          alt=""
          class="selected-icon ml-auto mr-0"
        >
        <div
          v-else
          class="checkbox ml-auto mr-0 cursor-pointer"
        />
      </div>
    </div>

    <div
      v-if="state.switchLeague"
      class="buttons fixed px-3 py-4 w-full bottom-f-h"
    >
      <d-button
        class="select-all w-full block is-btn"
        type="primary"
        @click="confirmSelect()"
      >
        {{ $t('components_common_dialog_confirm') }}
      </d-button>
    </div>
  </locale>
  <d-footer-row />
</template>

<script>
import {
  reactive, onBeforeMount, ref, computed,
} from 'vue';
import { useI18n } from 'vue-i18n';
import { useRouter } from 'vue-router';
import dayjs from 'dayjs';
import { useStore } from 'vuex';
import Locale from '@/components/Locale';

import LeagueList from '@/components/_pages/match/leagueList';
import SportApi from '@/assets/js/api/sportApi.js';
import { isArray } from '@/assets/js/utils/utils';

export default {
  components: {
    LeagueList,
    Locale,
  },
  setup() {
    // use
    const { t } = useI18n();
    const router = useRouter();
    const store = useStore();

    // ref
    const LeagueListParams = ref({
      timeType: 'matchTime',
      startTime: dayjs().format('YYYY/MM/DD HH:mm:ss'),
      endTime: dayjs().add(6, 'day').format('YYYY/MM/DD HH:mm:ss'),
    });

    // reactive
    const state = reactive({
      tabList:
      [
        { label: t('views_match_tablist_all'), type: 'all' },
        { label: t('views_match_tablist_today'), type: 'today' },
        { label: t('views_match_tablist_tomorrow'), type: 'tomorrow' },
        { label: t('views_match_tablist_record'), type: 'history' },
      ],
      currentKey: 0,
      tabIndex: 0,
      switchLeague: false,
      leagueList: [],
      seachLeagueList: [],
      gameSummaryList: [],
      timeFilter: 'all',
    });

    // computed
    const avatar = computed(() => store.state.user.avatar);
    const s3Base = computed(() => process.env.VUE_APP_BASE_CDN_URL);

    // methods
    const getLeagueSummary = async (params, isStartFromStartOfDay = true) => {
      const res = await SportApi.getLeagueSummary(params, isStartFromStartOfDay);
      if (res.code === 200) {
        state.seachLeagueList = [];
        if (isArray(res.data.leaguesInfo)) {
          const leagueList = res.data.leaguesInfo.map((item) => {
            item.selected = true;
            return item;
          });
          state.leagueList = leagueList;
        }
      }
    };

    const goPage = (url) => {
      router.push(url);
    };

    const selectLeague = (item) => {
      if (item.selected) {
        item.selected = false;
        const unSelectedIndex = state.seachLeagueList.findIndex((e) => e === item.leagueId);
        state.seachLeagueList.splice(unSelectedIndex, 1);
      } else {
        item.selected = true;
        state.seachLeagueList.push(item.leagueId);
      }
    };

    const selectAll = () => {
      state.seachLeagueList = [];
      state.leagueList.forEach((item) => {
        state.seachLeagueList.push(item.leagueId);
        item.selected = true;
      });
    };

    const invertSelect = () => {
      state.seachLeagueList = [];
      const unSelectArr = state.leagueList.filter((item) => !item.selected);
      state.leagueList.forEach((items) => {
        items.selected = !items.selected;
      });

      unSelectArr.forEach((element) => {
        state.seachLeagueList.push(element.leagueId);
      });
    };

    const confirmSelect = () => {
      if (!state.seachLeagueList.length) {
        window.$vue.$message.info(t('views_market_switchLeague_noSelected'));
      } else {
        state.switchLeague = false;
      }
    };

    const changeTab = async (index) => {
      state.tabIndex = index;
      state.seachLeagueList = [];
      state.leagueList = [];
      // 全部賽事
      if (index === 0) {
        state.timeFilter = 'all';
        LeagueListParams.value = {
          timeType: 'matchTime',
          startTime: dayjs().format('YYYY/MM/DD HH:mm:ss'),
          endTime: dayjs().add(6, 'day').format('YYYY/MM/DD HH:mm:ss'),
        };
        await getLeagueSummary(LeagueListParams.value, false);
      // 今日賽事
      } else if (index === 1) {
        state.timeFilter = 'today';
        LeagueListParams.value = {

          timeType: 'matchTime',
          startTime: dayjs().format('YYYY/MM/DD HH:mm:ss'),
          endTime: dayjs().format('YYYY/MM/DD HH:mm:ss'),
        };
        await getLeagueSummary(LeagueListParams.value, false);

      // 明日賽事
      } else if (index === 2) {
        state.timeFilter = 'tomorrow';
        LeagueListParams.value = {
          timeType: 'matchTime',
          startTime: dayjs().add(1, 'day').format('YYYY/MM/DD HH:mm:ss'),
          endTime: dayjs().add(1, 'day').format('YYYY/MM/DD HH:mm:ss'),
        };
        await getLeagueSummary(LeagueListParams.value);
        // 歷史賽事
      } else if (index === 3) {
        state.timeFilter = 'history';
        LeagueListParams.value = {
          timeType: 'matchTime',
          startTime: dayjs().subtract(6, 'day').format('YYYY/MM/DD HH:mm:ss'),
          endTime: dayjs().format('YYYY/MM/DD HH:mm:ss'),
        };
        await getLeagueSummary(LeagueListParams.value);
      }
    };

    const handlerOpenLeagueList = () => {
      if (!state.seachLeagueList.length) {
        state.leagueList.forEach((item) => {
          state.seachLeagueList.push(item.leagueId);
        });
      }
      state.switchLeague = true;
    };

    const goBack = () => {
      if (state.switchLeague) {
        if (!state.seachLeagueList.length) {
          window.$vue.$message.info(t('views_market_switchLeague_noSelected'));
        } else {
          state.switchLeague = false;
        }
      } else {
        router.back();
      }
    };

    // hooks
    onBeforeMount(async () => {
      await getLeagueSummary(LeagueListParams.value, false);
    });

    return {
      state,
      changeTab,
      goBack,
      selectLeague,
      selectAll,
      LeagueListParams,
      avatar,
      goPage,
      invertSelect,
      confirmSelect,
      s3Base,
      handlerOpenLeagueList,
    };
  },
};
</script>

<style lang="postcss" scoped>
.switch-league {
  width: 58px;
  border-radius: 20px 0 0 20px;
  background: transparent linear-gradient(180deg, #f3ac0a 0%, #7a5605 100%);
  box-shadow: 0 3px 6px #00000029;

  img {
    display: block;
    width: 28px;
    margin: 0 auto;
  }
}

.go-back {
  img {
    width: 18px;
    height: 18px;
  }
}

.tab-row {
  ::v-deep(.d-tabs-mobile .d-tabs-mobile-area .d-tabs-mobile-box) {
    justify-content: space-between !important;
  }

  .game-tab {
    flex: 0 0 85%;
  }

  .filter {
    flex: 0 0 15%;
  }
}

.league-list {
  border-radius: 5px;
  background: #142340;

  .league-title {
    color: #ffb83d;
  }

  .league-bet-time {
    color: #fff4d9;
  }
}

.selected-icon {
  width: 18px;
}

.checkbox {
  width: 18px;
  height: 18px;
  border: 0.5px solid #6c82ac;
  border-radius: 50%;
}

.buttons {
  @apply flex justify-center;

  .select-all {
    width: 345px;
    border-radius: 20px;
  }
}

.select-option {
  top: calc(var(--header-height) + 20px);
}

.select-aciton {
  height: 36px;
  border: 1px solid #ffb83d;
  border-radius: 20px;
  color: #ffb83d;
  background: #10192e;
}

.game-tab {
  ::v-deep(.d-tabs-mobile-box) {
    justify-content: space-start !important;

    .d-tabs-mobile-title {
      margin-right: 8px !important;
    }
  }

  &.zh_cn {
    ::v-deep(.d-tabs-mobile-box) {
      justify-content: center !important;

      .d-tabs-mobile-title {
        margin-right: 16px !important;
      }
    }
  }

  &.zh_tw {
    ::v-deep(.d-tabs-mobile-box) {
      justify-content: center !important;

      .d-tabs-mobile-title {
        margin-right: 16px !important;
      }
    }
  }
}

.all-league-list {
  display: -webkit-box;
  display: -ms-flexbox;
}

.league-img {
  width: 32px;
  height: 32px;
}
</style>
